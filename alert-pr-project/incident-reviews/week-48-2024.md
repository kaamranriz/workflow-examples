# Weekly Incident Review - Week 48, 2024

**Date:** November 25-29, 2024
**Facilitator:** Alex Kim (Platform Lead)
**Attendees:** Platform Team, Payments Team

---

## Executive Summary

Black Friday week with heavy traffic. We had one P1 incident during peak shopping and one P2 related to certificate expiration. Lessons learned focused on capacity planning and certificate management.

---

## Incident 1: Certificate Expiration on Payment Gateway

**Incident ID:** INC-2024-1128-001
**Severity:** P1
**Duration:** 8 minutes (03:12 - 03:20 UTC)
**Services Affected:** payment-service

### Timeline
- 03:12 - TLS certificate for internal payment gateway expires
- 03:12 - All payment requests fail with SSL errors
- 03:13 - PagerDuty alert fires for payment error rate
- 03:15 - On-call identifies certificate expiration in logs
- 03:18 - Emergency certificate renewal using Let's Encrypt
- 03:20 - Certificate deployed, service restored

### Root Cause
The TLS certificate for the internal payment gateway integration had a 90-day validity and was not in the certificate monitoring system. It expired at 03:12 UTC during Black Friday weekend.

### Impact
- 8 minutes of complete payment outage
- ~450 failed transactions
- Estimated revenue impact: $125,000

### What Went Well
- Quick detection via existing error rate alert
- On-call responded within 2 minutes
- Emergency cert process worked

### What Went Wrong
- **No alert for certificate expiration** - this cert wasn't monitored
- Certificate was manually provisioned, not in automation
- No advance warning despite 90-day expiry being known

### Action Items

#### Alert Improvements Needed

1. **Add alert for TLS certificate expiring within 30 days**
   - Alert for all certificates in production
   - Service: infrastructure
   - Severity: warning
   - Team: platform
   - 30-day advance notice

2. **Add alert for TLS certificate expiring within 7 days**
   - Alert for all certificates in production
   - Service: infrastructure
   - Severity: critical
   - Team: platform
   - Urgent action needed

3. **Add alert for TLS certificate expired**
   - Alert immediately when any certificate is detected as expired
   - Service: infrastructure
   - Severity: critical
   - Team: platform
   - Should never fire if above alerts work

4. **Add alert for SSL handshake failures**
   - Alert when SSL/TLS handshake error rate exceeds 0.1%
   - Service: payment-service
   - Severity: critical
   - Team: payments
   - Catches certificate issues from application perspective

---

## Incident 2: Kafka Consumer Lag During Black Friday Peak

**Incident ID:** INC-2024-1129-001
**Severity:** P2
**Duration:** 2 hours (13:00 - 15:00 UTC)
**Services Affected:** notification-service, order-service

### Timeline
- 13:00 - Black Friday traffic peaks at 5x normal
- 13:15 - Order confirmation emails begin delaying
- 13:30 - Customer complaints about missing order confirmations
- 14:00 - Engineering identifies Kafka consumer lag
- 14:30 - Notification service scaled up 3x
- 15:00 - Consumer lag cleared, emails sent

### Root Cause
The notification-service Kafka consumer was not sized for Black Friday traffic. Consumer lag grew to 500k messages, causing order confirmation emails to be delayed by up to 2 hours.

### Impact
- Order confirmation emails delayed 30-120 minutes
- Increased customer support tickets
- No data loss (emails eventually delivered)

### What Went Well
- No messages lost
- Scaling fixed the issue

### What Went Wrong
- **No alert for Kafka consumer lag** - discovered via customer complaints
- Notification service wasn't included in Black Friday capacity planning
- No visibility into email delivery latency

### Action Items

#### Alert Improvements Needed

5. **Add alert for Kafka consumer lag on notification topic**
   - Alert when consumer lag exceeds 10,000 messages for more than 5 minutes
   - Service: notification-service
   - Severity: warning
   - Team: orders
   - Catches backlog before significant delay

6. **Add alert for Kafka consumer lag critical on notification topic**
   - Alert when consumer lag exceeds 100,000 messages
   - Service: notification-service
   - Severity: critical
   - Team: orders
   - Major backlog requiring immediate scaling

7. **Add alert for email delivery latency**
   - Alert when time from order creation to email sent exceeds 5 minutes (P95)
   - Service: notification-service
   - Severity: warning
   - Team: orders
   - Customer-facing metric for email delays

8. **Add alert for Kafka consumer offline**
   - Alert when notification consumer group has no active consumers
   - Service: notification-service
   - Severity: critical
   - Team: orders
   - Complete email processing failure

---

## Summary of Alert Improvements

| # | Alert | Service | Severity | Team | Priority |
|---|-------|---------|----------|------|----------|
| 1 | Cert expiring in 30 days | infrastructure | warning | platform | P1 |
| 2 | Cert expiring in 7 days | infrastructure | critical | platform | P1 |
| 3 | Cert expired | infrastructure | critical | platform | P1 |
| 4 | SSL handshake failures > 0.1% | payment-service | critical | payments | P1 |
| 5 | Kafka lag > 10k | notification-service | warning | orders | P2 |
| 6 | Kafka lag > 100k | notification-service | critical | orders | P2 |
| 7 | Email delivery P95 > 5min | notification-service | warning | orders | P2 |
| 8 | Kafka consumer offline | notification-service | critical | orders | P2 |

---

## Capacity Planning Action Items

1. **Notification Service:** Include in future Black Friday planning
2. **Certificate Inventory:** Audit all production certificates, add to monitoring
3. **Pre-Peak Testing:** Run load tests at 5x capacity before major events

---

**Next Review:** December 6, 2024


