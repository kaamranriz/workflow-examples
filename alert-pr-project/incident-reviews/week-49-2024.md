# Weekly Incident Review - Week 49, 2024

**Date:** December 2-6, 2024
**Facilitator:** Mike Rodriguez (SRE)
**Attendees:** Platform Team, Identity Team, Orders Team

---

## Executive Summary

Relatively quiet week with 2 incidents: one P2 affecting user authentication and one P3 involving slow inventory queries. Total customer impact was approximately 20 minutes of degraded service.

---

## Incident 1: Redis Session Store Failover

**Incident ID:** INC-2024-1203-001
**Severity:** P2
**Duration:** 15 minutes (08:45 - 09:00 UTC)
**Services Affected:** user-service, api-gateway

### Timeline
- 08:45 - Primary Redis session store becomes unresponsive
- 08:46 - Sentinel detects failure, begins failover
- 08:48 - Failover completes to replica
- 08:50 - Existing user sessions invalidated (expected during failover)
- 08:55 - User complaints about being logged out
- 09:00 - New sessions working normally

### Root Cause
The primary Redis instance ran out of memory due to a large session data payload from a new feature. Sentinel correctly failed over to the replica, but all active sessions were lost during the switchover.

### Impact
- ~15,000 users logged out
- Login rate increased 10x temporarily
- Customer complaints about lost shopping carts

### What Went Well
- Sentinel failover worked correctly
- Service recovered automatically

### What Went Wrong
- **No advance warning of Redis memory pressure** - caught only after failure
- Session data size increase wasn't anticipated
- No alert for session store failover events

### Action Items

#### Alert Improvements Needed

1. **Add alert for session Redis memory approaching limit**
   - Alert when Redis memory usage exceeds 75% of maxmemory
   - Service: user-service
   - Severity: warning
   - Team: identity
   - Allows proactive scaling before failure

2. **Add alert for session Redis evictions**
   - Alert when Redis key evictions exceed 100/second
   - Service: user-service
   - Severity: warning
   - Team: identity
   - Indicates memory pressure before OOM

3. **Add alert for Redis Sentinel failover events**
   - Alert immediately when Sentinel performs a failover
   - Service: user-service
   - Severity: critical
   - Team: identity
   - Awareness of failover for debugging session issues

4. **Add alert for abnormal login rate spike**
   - Alert when login attempts exceed 3x normal rate for more than 2 minutes
   - Service: user-service
   - Severity: warning
   - Team: identity
   - Could indicate mass session invalidation or attack

---

## Incident 2: Inventory Service Slow Queries

**Incident ID:** INC-2024-1205-001
**Severity:** P3
**Duration:** 45 minutes (14:00 - 14:45 UTC)
**Services Affected:** inventory-service, order-service

### Timeline
- 14:00 - Inventory queries begin timing out
- 14:10 - Order placement becomes slow
- 14:15 - Developer notices missing database index on inventory table
- 14:30 - Index creation started
- 14:45 - Index creation complete, queries fast again

### Root Cause
A recent migration added a new column to the inventory table but did not include an index that was needed for a common query pattern. Query times went from 50ms to 5s.

### Impact
- Order placement latency increased from 500ms to 6s
- Some order timeouts during peak
- No data loss

### What Went Well
- Database team quickly identified missing index
- Index creation was non-blocking

### What Went Wrong
- **No alert for inventory-service query latency** - discovered via downstream order issues
- PR review didn't catch missing index
- No database query performance monitoring

### Action Items

#### Alert Improvements Needed

5. **Add alert for inventory-service database query latency**
   - Alert when P95 query latency exceeds 500ms for more than 5 minutes
   - Service: inventory-service
   - Severity: warning
   - Team: orders
   - Catches slow queries before impacting orders

6. **Add alert for inventory-service database connection wait time**
   - Alert when average connection pool wait time exceeds 100ms
   - Service: inventory-service
   - Severity: warning
   - Team: orders
   - Indicates connection pool stress

7. **Add alert for order-service dependency latency**
   - Alert when latency to inventory-service exceeds 1 second (P95)
   - Service: order-service
   - Severity: warning
   - Team: orders
   - Catches downstream issues from order perspective

---

## Summary of Alert Improvements

| # | Alert | Service | Severity | Team | Priority |
|---|-------|---------|----------|------|----------|
| 1 | Redis memory > 75% | user-service | warning | identity | P1 |
| 2 | Redis evictions > 100/s | user-service | warning | identity | P1 |
| 3 | Redis Sentinel failover | user-service | critical | identity | P1 |
| 4 | Login rate > 3x normal | user-service | warning | identity | P2 |
| 5 | Inventory query latency P95 > 500ms | inventory-service | warning | orders | P2 |
| 6 | Inventory connection wait > 100ms | inventory-service | warning | orders | P2 |
| 7 | Orderâ†’Inventory latency P95 > 1s | order-service | warning | orders | P2 |

---

## Process Improvements

1. **Database Reviews:** Add index coverage check to PR review checklist
2. **Capacity Planning:** Review Redis memory limits quarterly
3. **Runbook Updates:** Create runbook for session store failover recovery

---

**Next Review:** December 13, 2024


